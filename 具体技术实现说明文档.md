# 关键技术实现说明文档 (Implementation Details)

## 1. 姿态解算与卡尔曼滤波 (Kalman Filter)
### 1.1 技术难点
*   **加速度计问题**: 动态运动时受重力以外的加速度干扰，数据噪声大，短时不可靠。
*   **陀螺仪问题**: 存在零点漂移，积分运算会导致误差随时间累积，长时不可靠。

### 1.2 解决方案
在 `Middlewares/Algorithm/kalman.c` 中实现了二阶卡尔曼滤波器，融合两者数据：
1.  **预测 (Predict)**: 利用陀螺仪的角速度积分，预测下一时刻的角度。
2.  **更新 (Update)**: 利用加速度计计算出的重力角度作为观测值，修正预测值。

### 1.3 代码实现
```c
// Task_Sensor.c 中的调用
// Delta_t: 采样周期 (0.005s)
// Q_angle: 过程噪声 (0.001)
// R_measure: 测量噪声 (0.03)
Roll = Kalman_GetAngle(&K_Roll, roll_a, gx / 16.4f, Delta_t);
```
此算法成功解决了单纯互补滤波的滞后问题，实现了快速且稳定的姿态跟踪。

## 2. 数据中心 (DataCenter) 与线程安全
### 2.1 设计模式
采用**发布-订阅**模式的简化版。`DataCenter` 作为系统唯一的数据仓库。

### 2.2 线程安全挑战
`Task_Sensor` (写者) 和 `Task_Display` (读者) 并发运行。若不加锁，可能出现“读到一半”的数据（例如：时间从 12:59:59 跳变到 13:00:00 瞬间，可能读出 12:00:00）。

### 2.3 实现机制
使用 FreeRTOS 的 **Mutex (互斥量)**：
```c
void DataCenter_SetSensorData(float roll, ...) {
    if(xSemaphoreTake(SensorMutex, portMAX_DELAY) == pdTRUE) {
        SensorData.Roll = roll;
        // ... 赋值操作
        xSemaphoreGive(SensorMutex);
    }
}
```
这确保了数据的**原子性访问**。

## 3. UI 框架与平滑动画
### 3.1 页面管理
使用**状态机**管理页面 (`UI_Manager.c`)。每个页面封装为三个标准接口：
*   `xxx_Init()`: 初始化数据。
*   `xxx_Draw()`: 绘制逻辑。
*   `xxx_HandleKey()`: 按键回调。

### 3.2 菜单滑动算法
为了实现丝滑的菜单切换，`Page_Menu.c` 引入了**插值动画**：
*   定义 `pre_selection` (当前视觉位置) 和 `target_selection` (目标逻辑位置)。
*   在每次 `Draw` 循环中，计算 `x_pre` (当前 X 坐标) 与目标坐标的差值。
*   每次步进移动 `4px`，直到重合。
*   这使得菜单图标在切换时产生物理惯性般的滑动效果，而非生硬跳变。

## 4. 抬手亮屏算法
### 4.1 逻辑流程
1.  **监测**: `Task_Sensor` 以 200Hz 频率监测 Roll 和 Pitch。
2.  **判定**: 设定“观察姿态”阈值区间（如 Roll: -30°~30°, Pitch: 20°~80°）。
3.  **触发**: 检测到姿态从“非观察区”进入“观察区”的**上升沿**信号。
4.  **执行**: 置位 `IsScreenOn` 标志，重置息屏倒计时。

---

## 5. 面试问答锦囊 (Q&A Tips)

**Q1: 为什么选择 FreeRTOS 而不是裸机开发？**
> **A**: 项目涉及 UI 刷新、传感器高频采样和复杂算法。裸机的大循环结构难以平衡高实时性（传感器）和高耗时（UI 刷新）任务。FreeRTOS 的**抢占式调度**允许高优先级的 UI 任务打断计算任务，保证了界面的流畅性，同时利用信号量解决了并发冲突。

**Q2: 卡尔曼滤波参数是如何调整的？**
> **A**: 主要调整过程噪声协方差 `Q_angle` 和测量噪声协方差 `R_measure`。增大 `Q_angle` 会让系统更信任陀螺仪（响应快但有漂移风险），增大 `R_measure` 会更信任加速度计（稳定但有滞后）。我在实测中通过串口打印波形，最终找到了兼顾响应速度和稳定性的参数组合。

**Q3: 项目中最大的难点是什么？**
> **A**: 是多任务环境下的**数据一致性**问题。初期偶发显示数据乱码，后来通过引入 `DataCenter` 模块并配合 FreeRTOS 的互斥量机制，规范了所有全局数据的读写权限，彻底解决了竞态条件引发的 Bug。
Q4：现在的架构有什么好处？
答：现在的架构实现了软硬解耦。如果未来我要把 MCU 换成 ESP32，或者把 MPU6050 换成 MPU9250，我只需要重写 Drivers 层，上层的 App 和 Middlewares 代码几乎不需要改动