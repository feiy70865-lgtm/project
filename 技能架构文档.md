# 系统技术架构设计文档 (System Architecture)

## 1. 硬件架构
本项目基于 STM32 标准开发板构建，外设资源分配如下：

*   **主控芯片**: STM32F103C8T6 (ARM Cortex-M3, 72MHz, 64KB Flash, 20KB RAM)
*   **显示模块**: 0.96寸 OLED (SSD1306 控制器, I2C 接口)
*   **传感器**: MPU6050 六轴传感器 (3轴加速度 + 3轴陀螺仪, I2C 接口)
*   **存储扩展**: W25Q64 (64M-bit SPI Flash, 用于存储字库、图标资源)
*   **人机交互**: 独立按键 x 3 (GPIO 输入)
*   **调试接口**: SWD (Serial Wire Debug)

## 2. 软件架构 (Layered Architecture)
项目采用严格的**分层解耦**设计，自下而上分为三层，层与层之间通过标准 API 通讯。

### 2.1 驱动层 (Drivers Layer)
位于 `Drivers/` 目录，负责直接操作硬件寄存器。
*   **CMSIS & StdPeriph**: ARM 与 ST 官方提供的标准库。
*   **BSP (Board Support Package)**: 板级支持包，封装具体硬件细节。
    *   `bsp_oled.c`: 提供绘图点、线、图的底层接口。
    *   `bsp_mpu6050.c`: 封装 I2C 通信协议，提供原始数据读取接口。
    *   `bsp_key.c`: 提供按键状态扫描接口。
    *   **设计优势**: 上层业务逻辑无需关心底层是硬件 I2C 还是模拟 I2C，便于硬件移植。

### 2.2 中间件层 (Middlewares Layer)
位于 `Middlewares/` 目录，提供独立于硬件的通用服务。
*   **FreeRTOS**: 实时操作系统内核，负责任务调度、时间管理、任务间同步与通信。
*   **Algorithm**: 纯算法模块。
    *   `kalman.c`: 标准卡尔曼滤波算法实现。
    *   `step_algo.c`: 计步检测算法。

### 2.3 应用层 (App Layer)
位于 `App/` 目录，采用类 **MVC (Model-View-Controller)** 思想设计。
*   **Model (数据中心)**: `App/Model/DataCenter.c`
    *   系统的“单一数据源”，管理传感器数据、时间、系统设置等。
    *   使用 **Mutex (互斥量)** 保证多任务环境下的数据线程安全。
*   **View (UI 视图)**: `App/UI/`
    *   `UI_Manager.c`: 页面状态机，管理页面切换逻辑。
    *   `Pages/`: 各个功能页面的绘制实现（如 `Page_Clock`, `Page_Menu`）。
    *   采用**显存缓冲 (FrameBuffer)** 机制，一次性刷新，避免屏幕闪烁。
*   **Controller (任务逻辑)**: `App/Tasks/`
    *   负责具体的业务逻辑执行，连接输入（传感器/按键）与输出（UI/LED）。

## 3. FreeRTOS 任务划分
系统根据实时性要求，划分了以下核心任务：

| 任务名称 | 优先级 | 堆栈大小 | 调度频率 | 职责描述 |
| :--- | :--- | :--- | :--- | :--- |
| **Task_Display** | High (4) | 256 Words | 30Hz | 负责 OLED 显存刷新，高优先级保证 UI 流畅度，无撕裂。 |
| **Task_Sensor** | Medium (3) | 128 Words | 200Hz | 读取 MPU6050 数据，执行卡尔曼滤波解算，更新 DataCenter。 |
| **Task_Input** | Medium (3) | 128 Words | 50Hz | 扫描按键状态，执行消抖，向系统发送按键事件。 |
| **Task_Manager** | Low (2) | 128 Words | 10Hz | 系统状态监控，低功耗管理，后台逻辑处理。 |

---
*此架构设计确保了高实时性任务（如 UI 刷新）不会被低速 I/O 阻塞，同时保证了数据的一致性。*
